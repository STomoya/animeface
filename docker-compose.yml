services:
  torch:
    build:
      context: .
      dockerfile: ./docker/torch/Dockerfile
      args:
        - BASE_TORCH_VERSION=2.0.1
        - BASE_CUDA_VERSION=11.7
        - BASE_CUDNN_VERSION=8
        - UID=${UID}
        - USERNAME=torchuser

    volumes:
      - .:${WORKING_DIR}
      - /mnt/D/Data/animefacedataset:${WORKING_DIR}/data/animefacedataset
      - /mnt/D/Data/danbooru:${WORKING_DIR}/data/danbooru
      - /mnt/D/Data/illustration2vec:${WORKING_DIR}/data/illustration2vec
      - /mnt/D/Data/celeba:${WORKING_DIR}/data/celeba

    shm_size: '8gb'
    init: true
    working_dir: ${WORKING_DIR}
    environment:
      - CUDA_HOME=${CUDA_HOME}
      - XDG_CACHE_HOME=${XDG_CACHE_HOME}
      - TORCH_EXTENSIONS_DIR=${XDG_CACHE_HOME}/${TORCH_EXTENSIONS_DIR}
    entrypoint: []
    user: ${UID:-1000}

    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              capabilities: [gpu]
              device_ids: ['0']


  preprocess:
    build:
      context: .
      dockerfile: docker/preprocess/Dockerfile
      args:
        - BASE_TORCH_VERSION=2.0.1
        - BASE_CUDA_VERSION=11.7
        - BASE_CUDNN_VERSION=8
        - UID=${UID}
        - USERNAME=torchuser

    volumes:
      - .:${WORKING_DIR}
      - /mnt/D/Data/animefacedataset:${WORKING_DIR}/data/animefacedataset
      - /mnt/D/Data/danbooru:${WORKING_DIR}/data/danbooru
      - /mnt/D/Data/illustration2vec:${WORKING_DIR}/data/illustration2vec
      - /mnt/D/Data/celeba:${WORKING_DIR}/data/celeba

    shm_size: '8gb'
    init: true
    working_dir: ${WORKING_DIR}
    environment:
      - CUDA_HOME=${CUDA_HOME}
      - XDG_CACHE_HOME=${XDG_CACHE_HOME}
      - TORCH_EXTENSIONS_DIR=${XDG_CACHE_HOME}/${TORCH_EXTENSIONS_DIR}
    entrypoint: []
    user: ${UID:-1000}

    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              capabilities: [gpu]
              device_ids: ['0']
